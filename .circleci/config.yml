version: 2.1

# this allows you to use CircleCI's dynamic configuration feature
setup: true

orbs:
  path-filtering: circleci/path-filtering@1.0.0
  continuation: circleci/continuation@1.0.0

#  Potential parameters that can come from the project GUI Triggers
parameters:
  api-level:
    type: integer
    default: 0

workflows:
  pr-tests:
    when:
      and:
        - equal: [ "webhook", << pipeline.trigger_source >> ]
        - matches:
            pattern: "^pull/\\d+$"
            value: << pipeline.git.branch >>
    jobs:
      - pr-danger:
          name: Danger PR Check
      # the path-filtering/filter job determines which libs to test.
      - path-filtering/filter:
          name: check-updated-files
          # 3-column, whitespace-delimited mapping. One mapping per line:
          # <regex path-to-test> <parameter-to-set> <value-of-pipeline-parameter>
          mapping: |
            libs/SalesforceAnalytics/.* test-SalesforceAnalytics true
            libs/test/SalesforceAnalyticsTest/.* test-SalesforceAnalytics true
            libs/SalesforceSDK/.* test-SalesforceSDK true
            libs/test/SalesforceSDKTest/.* test-SalesforceSDK true
            libs/SmartStore/.* test-SmartStore true
            libs/test/SmartStoreTest/.* test-SmartStore true
            libs/MobileSync/.* test-MobileSync true
            libs/test/MobileSyncTest/.* test-MobileSync true
            libs/SalesforceHybrid/.* test-SalesforceHybrid true
            libs/test/SalesforceHybridTest/.* test-SalesforceHybrid true
            libs/SalesforceReact/.* test-SalesforceReact true
            libs/test/SalesforceReactTest/.* test-SalesforceReact true
            libs/SalesforceSDK/src/com/salesforce/androidsdk/ui/.* test-RestExplorer true
          base-revision: dev
          config-path: ./lib_test_config.yml

  # GUI Driven "Triggers" Schedule
  # Monday    8 PM - API 24
  # Monday    9 PM - API 26
  # Monday   10 PM - API 27
  # Monday   11 PM - API 30
  # Tuesday  12 AM - API 32
  # Friday    8 PM - API 25
  # Friday    9 PM - API 27
  # Friday   10 PM - API 29
  # Friday   11 PM - API 31
  # Saturday 12 AM - API 33
  nightly-tests:
    when:
      not:
        equal: [ "webhook", << pipeline.trigger_source >> ]
    jobs:
      - run-nightly-tests


jobs:
  pr-danger:
    docker:
      - image: cimg/ruby:3.2.2
    steps:
      - run:
          command: danger --dangerfile=.circleci/Dangerfile_PR.rb --danger_id=PR-Check --verbose
          background: true

  run-nightly-tests:
    executor: continuation/default
    steps:
      - continuation/continue:
          configuration_path: ./lib_test_config.yml
          parameters: '{"pr": false, "api-level": << pipeline.parameters.api-level >> }'
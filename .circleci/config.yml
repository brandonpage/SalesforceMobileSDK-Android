aliases:
  - &gradle-cache-key
    gradle-cache-v2-{{ checksum "build.gradle" }}-{{
      checksum "gradle/wrapper/gradle-wrapper.properties" }}-{{
      checksum "libs/SalesforceAnalytics/build.gradle" }}-{{
      checksum "libs/SalesforceSDK/build.gradle" }}-{{
      checksum "libs/SmartStore/build.gradle" }}-{{
      checksum "libs/SmartSync/build.gradle" }}-{{
      checksum "libs/SalesforceHybrid/build.gradle" }}-{{
      checksum "libs/SalesforceReact/build.gradle" }}

  - &restore-gradle-cache
    keys:
      - *gradle-cache-key

  - &restore-node-cache
    keys:
      - node-cache-{{ checksum "package.json" }}

  - &restore-ruby-cache
    keys:
      - ruby-gem-cache-{{ .BuildNum }}
      - ruby-gem-cache-

  - &save-gradle-cache
    key: *gradle-cache-key
    paths:
      - .gradle
      - /home/circleci/.gradle

  - &save-node-cache
    key: node-cache-{{ checksum "package.json" }}
    paths:
      - node_modules

  - &save-ruby-cache
    key: ruby-gem-cache-{{ .BuildNum }}
    paths:
      - /home/circleci/.rubies

  - &setup-env
    name: Setup Environment
    command: |
      sudo npm i npm@latest -g
      sudo npm install -g shelljs@0.8.3
      sudo npm install -g cordova@8.1.2
      cordova telemetry off
      ./install.sh
      gem install bundler
      gem install danger
      gem install danger-junit
      gem install danger-android_lint
      gem install danger-jacoco
      echo $TEST_CREDENTIALS > ./shared/test/test_credentials.json

  # Test APK paths
  - &analytics-apk-path
      "libs/SalesforceAnalytics/build/outputs/apk/androidTest/debug/SalesforceAnalytics-debug-androidTest.apk"
  - &coresdk-apk-path
      "libs/SalesforceSDK/build/outputs/apk/androidTest/debug/SalesforceSDK-debug-androidTest.apk"
  - &smartStore-apk-path
      "libs/SmartStore/build/outputs/apk/androidTest/debug/SmartStore-debug-androidTest.apk"
  - &smartSync-apk-path
      "libs/SmartSync/build/outputs/apk/androidTest/debug/SmartSync-debug-androidTest.apk"
  - &salesforceHybrid-apk-path
      "libs/SalesforceHybrid/build/outputs/apk/androidTest/debug/SalesforceHybrid-debug-androidTest.apk"
  - &restExplorer-apk-path
      "native/NativeSampleApps/RestExplorer/build/outputs/apk/androidTest/debug/RestExplorer-debug-androidTest.apk"
  - &salesforceReact-apk-path
      "libs/SalesforceReact/build/outputs/apk/androidTest/debug/SalesforceReact-debug-androidTest.apk"
    
version: 2.1
executors:
  linux:
    working_directory: ~/SalesforceMobileSDK-Android
    docker:
      - image: circleci/android:api-29-node
    environment:
      - TERM: "dumb"
      - GRADLE_OPTS: '-Dorg.gradle.jvmargs="-Xmx2048m -XX:+HeapDumpOnOutOfMemoryError"'

jobs:
  setup:
    executor: linux
    steps:
      - checkout
      - restore_cache: *restore-gradle-cache
      - restore_cache: *restore-node-cache
      - restore_cache: *restore-ruby-cache
      - run: *setup-env
      - run:
          name: Run Android Lint
          command:  ./gradlew lint
          when: always
      - run:
          name: Build for Testing
          command:  |
            ./gradlew libs:SalesforceAnalytics:assembleAndroidTest
            ./gradlew libs:SalesforceSDK:assembleAndroidTest
            ./gradlew libs:SmartStore:assembleAndroidTest
            ./gradlew libs:SmartSync:assembleAndroidTest
            ./gradlew libs:SalesforceHybrid:assembleAndroidTest
            ./gradlew libs:SalesforceReact:assembleAndroidTest
            ./gradlew native:NativeSampleApps:RestExplorer:assembleAndroidTest
            ./gradlew native:NativeSampleApps:RestExplorer:assembleDebug
      - run:
          name: Run Danger
          command: |
            if [[ $CIRCLE_BRANCH == *"pull"* ]]; then
                # These env vars are not set properly on rebuilds
                export CIRCLE_PULL_REQUEST="https://github.com/forcedotcom/SalesforceMobileSDK-Android/${CIRCLE_BRANCH}"
                export CIRCLE_PULL_REQUESTS="https://github.com/forcedotcom/SalesforceMobileSDK-Android/${CIRCLE_BRANCH}"
                export CI_PULL_REQUEST="https://github.com/forcedotcom/SalesforceMobileSDK-Android/${CIRCLE_BRANCH}"
                export CI_PULL_REQUESTS="https://github.com/forcedotcom/SalesforceMobileSDK-Android/${CIRCLE_BRANCH}"
                # This token is completely harmless as it only has public permission and
                # is owned by a bot who isn't a member of the org.
                DANGER_GITHUB_API_TOKEN="279a29d75427e4178cef""b7b5b2d7646c540f025a" danger --dangerfile=.circleci/Dangerfile_PR.rb --danger_id=PR-Check --verbose
            else
                echo "No need to run Danger."
            fi
      - save_cache: *save-gradle-cache
      - save_cache: *save-node-cache
      - save_cache: *save-ruby-cache
      - persist_to_workspace:
          root: .
          paths:
            - ./**

  run-tests:
    executor: linux
    parameters:
      lib:
        type: string
        default: "SalesforceAnalytics"
      test_apk:
        type: string
        default: *analytics-apk-path
      pr:
        type: boolean
        default: false
      api_level:
        type: integer
        default: 27
    environment:
      CURRENT_LIB: << parameters.lib >>
    steps:
      - attach_workspace:
          at: ~/SalesforceMobileSDK-Android
      - when:
          condition: << parameters.pr >>
          steps:
            - run:
                name: Determine Tests to Run
                command: |
                  LIBS_TO_TEST=$(ruby .circleci/gitChangedLibs.rb)
                  echo -e "export LIBS_TO_TEST=${LIBS_TO_TEST}" >> "${BASH_ENV}"

                  # Check if tests should run
                  if [[ ${LIBS_TO_TEST} == *"<< parameters.lib >>"* ]]; then
                      echo -e "\n\nLibraries to Test-> ${LIBS_TO_TEST//","/", "}."
                  else
                      echo -e "\n\nNo need to test << parameters.lib >> for this PR, stopping execution."
                      circleci step halt
                  fi
      - restore_cache: *restore-gradle-cache
      - restore_cache: *restore-node-cache
      - restore_cache: *restore-ruby-cache
      - run:
          name: Authorize gcloud and set config defaults
          command:  |
            echo $GCLOUD_SERVICE_KEY | base64 --decode --ignore-garbage > ${HOME}/gcloud-service-key.json
            gcloud auth activate-service-account --key-file=${HOME}/gcloud-service-key.json
            gcloud --quiet config set project mobile-apps-firebase-test
      - run:
          name: Run << parameters.lib >> Tests with API << parameters.api_level >>
          command: |
            [[ << parameters.api_level >> < 23 ]] && device="Nexus6" || device="NexusLowRes"

            gcloud firebase test android run \
                --project mobile-apps-firebase-test \
                --type instrumentation \
                --app "native/NativeSampleApps/RestExplorer/build/outputs/apk/debug/RestExplorer-debug.apk" \
                --test << parameters.test_apk >>  \
                --device model=$device,version=<< parameters.api_level >>,locale=en,orientation=portrait  \
                --environment-variables coverage=true,coverageFile="/sdcard/coverage.ec"  \
                --directories-to-pull=/sdcard  \
                --results-dir=<< parameters.lib >>-${CIRCLE_BUILD_NUM}  \
                --results-history-name=<< parameters.lib >>  \
                --timeout 10m --no-auto-google-login --no-record-video --no-performance-metrics
          no_output_timeout: 600
      - run:
          name: Copy test results data
          command: |
            mkdir -p firebase/results
            gsutil -m cp -r -U "`gsutil ls gs://test-lab-w87i9sz6q175u-kwp8ium6js0zw/<< parameters.lib >>-api<< parameters.api_level >>-${CIRCLE_BUILD_NUM} | tail -1`*" ./firebase/
            mv firebase/test_result_1.xml firebase/results/
          when: always
      - when:
          condition: << parameters.pr >>
          steps:
            - run:
                name: Run Danger
                command: |
                  # These env vars are not set properly on rebuilds
                  export CIRCLE_PULL_REQUEST="https://github.com/forcedotcom/SalesforceMobileSDK-Android/${CIRCLE_BRANCH}"
                  export CIRCLE_PULL_REQUESTS="https://github.com/forcedotcom/SalesforceMobileSDK-Android/${CIRCLE_BRANCH}"
                  export CI_PULL_REQUEST="https://github.com/forcedotcom/SalesforceMobileSDK-Android/${CIRCLE_BRANCH}"
                  export CI_PULL_REQUESTS="https://github.com/forcedotcom/SalesforceMobileSDK-Android/${CIRCLE_BRANCH}"

                  if ls libs/<< parameters.lib >>/build/outputs/androidTest-results/connected/*.xml 1> /dev/null 2>&1; then
                       mv libs/<< parameters.lib >>/build/outputs/androidTest-results/connected/*.xml libs/<< parameters.lib >>/build/outputs/androidTest-results/connected/test-results.xml
                  fi
                  # This token is completely harmless as it only has public permission and
                  # is owned by a bot who isn't a member of hte org.
                  DANGER_GITHUB_API_TOKEN="279a29d75427e4178cef""b7b5b2d7646c540f025a" danger --dangerfile=.circleci/Dangerfile_Lib.rb --danger_id=<< parameters.lib >> --verbose
                background: true
                when: always
            - run:
                name: Codecov
                command: bash <(curl -s https://codecov.io/bash) -f firebase/artifacts/coverage.ec
                background: true
                when: always
      - store_artifacts:
            path: firebase/
      - store_test_results:
            path: firebase/results

  generate-artifacts:
    executor: linux
    steps:
      - checkout
      - restore_cache: *restore-gradle-cache
      - restore_cache: *restore-node-cache
      - run: *setup-env
      - save_cache: *save-node-cache
      - run:
          name: Build Libraries
          command:  |
            ./gradlew :libs:SalesforceAnalytics:assemble
            ./gradlew :libs:SalesforceSDK:assemble
            ./gradlew :libs:SmartStore:assemble
            ./gradlew :libs:SmartSync:assemble
            ./gradlew :libs:SalesforceHybrid:assemble
            ./gradlew :libs:SalesforceReact:assemble
          when: always
      - store_artifacts:
          path: libs/SalesforceAnalytics/build/outputs/aar/
          destination: libraries
      - store_artifacts:
          path: libs/SalesforceSDK/build/outputs/aar/
          destination: libraries
      - store_artifacts:
          path: libs/SmartStore/build/outputs/aar/
          destination: libraries
      - store_artifacts:
          path: libs/SmartSync/build/outputs/aar/
          destination: libraries
      - store_artifacts:
          path: libs/SalesforceHybrid/build/outputs/aar/
          destination: libraries
      - store_artifacts:
          path: libs/SalesforceReact/build/outputs/aar/
          destination: libraries
      - run:
          name: Build Native Sample Apps
          when: always
          command:  |
            ./gradlew :native:NativeSampleApps:AppConfigurator:assemble
            ./gradlew :native:NativeSampleApps:ConfiguredApp:assemble
            ./gradlew :native:NativeSampleApps:RestExplorer:assemble
            ./gradlew :native:NativeSampleApps:SmartSyncExplorer:assemble
      - store_artifacts:
          path: native/NativeSampleApps/AppConfigurator/build/outputs/apk/
          destination: native-apps
      - store_artifacts:
          path: native/NativeSampleApps/ConfiguredApp/build/outputs/apk/
          destination: native-apps
      - store_artifacts:
          path: native/NativeSampleApps/RestExplorer/build/outputs/apk/
          destination: native-apps
      - store_artifacts:
          path: native/NativeSampleApps/SmartSyncExplorer/build/outputs/apk/
          destination: native-apps
      - run:
          name: Build Hybrid Sample Apps
          when: always
          command:  |
            ./gradlew :hybrid:HybridSampleApps:AccountEditor:assemble
            ./gradlew :hybrid:HybridSampleApps:NoteSync:assemble
            ./gradlew :hybrid:HybridSampleApps:SmartSyncExplorerHybrid:assemble
      - store_artifacts:
          path: hybrid/HybridSampleApps/AccountEditor/build/outputs/apk/
          destination: hybrid-apps
      - store_artifacts:
          path: hybrid/HybridSampleApps/NoteSync/build/outputs/apk/
          destination: hybrid-apps
      - store_artifacts:
          path: hybrid/HybridSampleApps/SmartSyncExplorerHybrid/build/outputs/apk/
          destination: hybrid-apps
      - save_cache: *save-gradle-cache


#####################
#                   #
#     Workflows     #
#                   #
#####################

workflows:
  version: 2

  # PRs run on Android API 27
  pr-test:
    jobs:
      - setup:
          filters:
            branches:
              only:
                - /pull.*/
      - run-tests:
          requires:
            - setup
          name: "SalesforceAnalytics"
          pr: true
      - run-tests:
          requires:
            - setup
          name: "SalesforceSDK"
          lib: "SalesforceSDK"
          test_apk: *coresdk-apk-path
          pr: true
      - run-tests:
          requires:
            - setup
          name: "SmartStore"
          lib: "SmartStore"
          test_apk: *smartStore-apk-path
          pr: true
      - run-tests:
          requires:
            - setup
          name: "SmartSync"
          lib: "SmartSync"
          test_apk: *smartSync-apk-path
          pr: true
      - run-tests:
          requires:
            - setup
          name: "SalesforceHybrid"
          lib: "SalesforceHybrid"
          test_apk: *salesforceHybrid-apk-path
          pr: true
      - run-tests:
          requires:
            - setup
          name: "RestExplorer"
          lib: "RestExplorer"
          test_apk: *restExplorer-apk-path
          pr: true
      - run-tests:
          requires:
            - setup
          name: "SalesforceReact"
          lib: "SalesforceReact"
          test_apk: *salesforceReact-apk-path
          pr: true


  # Cron are on a timezone 8 hours ahead of PST
  # Nightly run is set for ~10PM Monday and Friday
  test-all-api-versions:
     triggers:
       - schedule:
           cron: "00 6 * * 2,6"
           filters:
             branches:
               only:
                 - dev
     jobs:
        - generate-artifacts
        - setup
        - run-tests:
            requires:
              - setup
            name: "Analytics API 28"
        - run-tests:
            requires:
              - "Analytics API 28"
            name: "Analytics API 27"
        - run-tests:
            requires:
              - "Analytics API 27"
            name: "Analytics API 26"
        - run-tests:
            requires:
              - "Analytics API 26"
            name: "Analytics API 25"
        - run-tests:
            requires:
              - "Analytics API 25"
            name: "Analytics API 24"
        - run-tests:
            requires:
              - "Analytics API 24"
            name: "Analytics API 23"
        - run-tests:
            requires:
              - "Analytics API 23"
            name: "Analytics API 22"
        - run-tests:
            requires:
              - "Analytics API 22"
            name: "Analytics API 21"

        - run-tests:
            requires:
              - setup
            name: "SDK API 28"
            lib: "SalesforceSDK"
            test_apk: *coresdk-apk-path
        - run-tests:
            requires:
              - "SDK API 28"
            name: "SDK API 27"
            lib: "SalesforceSDK"
            test_apk: *coresdk-apk-path
        - run-tests:
            requires:
              - "SDK API 27"
            name: "SDK API 26"
            lib: "SalesforceSDK"
            test_apk: *coresdk-apk-path
        - run-tests:
            requires:
              - "SDK API 26"
            name: "SDK API 25"
            lib: "SalesforceSDK"
            test_apk: *coresdk-apk-path
        - run-tests:
            requires:
              - "SDK API 25"
            name: "SDK API 24"
            lib: "SalesforceSDK"
            test_apk: *coresdk-apk-path
        - run-tests:
            requires:
              - "SDK API 24"
            name: "SDK API 23"
            lib: "SalesforceSDK"
            test_apk: *coresdk-apk-path
        - run-tests:
            requires:
              - "SDK API 23"
            name: "SDK API 22"
            lib: "SalesforceSDK"
            test_apk: *coresdk-apk-path
        - run-tests:
            requires:
              - "SDK API 22"
            name: "SDK API 21"
            lib: "SalesforceSDK"
            test_apk: *coresdk-apk-path
        - run-tests:
            requires:
              - setup
            name: "Store API 28"
            lib: "SmartStore"
            test_apk: *smartStore-apk-path
        - run-tests:
            requires:
              - "Store API 28"
            name: "Store API 27"
            lib: "SmartStore"
            test_apk: *smartStore-apk-path
        - run-tests:
            requires:
              - "Store API 27"
            name: "Store API 26"
            lib: "SmartStore"
            test_apk: *smartStore-apk-path
        - run-tests:
            requires:
              - "Store API 26"
            name: "Store API 25"
            lib: "SmartStore"
            test_apk: *smartStore-apk-path
        - run-tests:
            requires:
              - "Store API 25"
            name: "Store API 24"
            lib: "SmartStore"
            test_apk: *smartStore-apk-path
        - run-tests:
            requires:
              - "Store API 24"
            name: "Store API 23"
            lib: "SmartStore"
            test_apk: *smartStore-apk-path
        - run-tests:
            requires:
              - "Store API 23"
            name: "Store API 22"
            lib: "SmartStore"
            test_apk: *smartStore-apk-path
        - run-tests:
            requires:
              - "Store API 22"
            name: "Store API 21"
            lib: "SmartStore"
            test_apk: *smartStore-apk-path
        - run-tests:
            requires:
              - setup
            name: "Sync API 28"
            lib: "SmartSync"
            test_apk: *smartSync-apk-path
        - run-tests:
            requires:
              - "Sync API 28"
            name: "Sync API 27"
            lib: "SmartSync"
            test_apk: *smartSync-apk-path
        - run-tests:
            requires:
              - "Sync API 27"
            name: "Sync API 26"
            lib: "SmartSync"
            test_apk: *smartSync-apk-path
        - run-tests:
            requires:
              - "Sync API 26"
            name: "Sync API 25"
            lib: "SmartSync"
            test_apk: *smartSync-apk-path
        - run-tests:
            requires:
              - "Sync API 25"
            name: "Sync API 24"
            lib: "SmartSync"
            test_apk: *smartSync-apk-path
        - run-tests:
            requires:
              - "Sync API 24"
            name: "Sync API 23"
            lib: "SmartSync"
            test_apk: *smartSync-apk-path
        - run-tests:
            requires:
              - "Sync API 23"
            name: "Sync API 22"
            lib: "SmartSync"
            test_apk: *smartSync-apk-path
        - run-tests:
            requires:
              - "Sync API 22"
            name: "Sync API 21"
            lib: "SmartSync"
            test_apk: *smartSync-apk-path
        - run-tests:
            requires:
              - setup
            name: "Hybrid API 28"
            lib: "SalesforceHybrid"
            test_apk: *salesforceHybrid-apk-path
        - run-tests:
            requires:
              - "Hybrid API 28"
            name: "Hybrid API 27"
            lib: "SalesforceHybrid"
            test_apk: *salesforceHybrid-apk-path
        - run-tests:
            requires:
              - "Hybrid API 27"
            name: "Hybrid API 26"
            lib: "SalesforceHybrid"
            test_apk: *salesforceHybrid-apk-path
        - run-tests:
            requires:
              - "Hybrid API 26"
            name: "Hybrid API 25"
            lib: "SalesforceHybrid"
            test_apk: *salesforceHybrid-apk-path
        - run-tests:
            requires:
              - "Hybrid API 25"
            name: "Hybrid API 24"
            lib: "SalesforceHybrid"
            test_apk: *salesforceHybrid-apk-path
        - run-tests:
            requires:
              - "Hybrid API 24"
            name: "Hybrid API 23"
            lib: "SalesforceHybrid"
            test_apk: *salesforceHybrid-apk-path
        - run-tests:
            requires:
              - "Hybrid API 23"
            name: "Hybrid API 22"
            lib: "SalesforceHybrid"
            test_apk: *salesforceHybrid-apk-path
        - run-tests:
            requires:
              - "Hybrid API 22"
            name: "Hybrid API 21"
            lib: "SalesforceHybrid"
            test_apk: *salesforceHybrid-apk-path
        - run-tests:
            requires:
              - setup
            name: "RestExplorer API 28"
        - run-tests:
            requires:
              - "RestExplorer API 28"
            name: "RestExplorer API 27"
            lib: "RestExplorer"
            test_apk: *restExplorer-apk-path
        - run-tests:
            requires:
              - "RestExplorer API 27"
            name: "RestExplorer API 26"
            lib: "RestExplorer"
            test_apk: *restExplorer-apk-path
        - run-tests:
            requires:
              - "RestExplorer API 26"
            name: "RestExplorer API 25"
            lib: "RestExplorer"
            test_apk: *restExplorer-apk-path
        - run-tests:
            requires:
              - "RestExplorer API 25"
            name: "RestExplorer API 24"
            lib: "RestExplorer"
            test_apk: *restExplorer-apk-path
        - run-tests:
            requires:
              - "RestExplorer API 24"
            name: "RestExplorer API 23"
            lib: "RestExplorer"
            test_apk: *restExplorer-apk-path
        - run-tests:
            requires:
              - "RestExplorer API 23"
            name: "RestExplorer API 22"
            lib: "RestExplorer"
            test_apk: *restExplorer-apk-path
        - run-tests:
            requires:
              - "RestExplorer API 22"
            name: "RestExplorer API 21"
            lib: "RestExplorer"
            test_apk: *restExplorer-apk-path
        - run-tests:
            requires:
              - setup
            name: "React API 28"
            lib: "SalesforceReact"
            test_apk: *salesforceReact-apk-path
        - run-tests:
            requires:
              - "React API 28"
            name: "React API 27"
            lib: "SalesforceReact"
            test_apk: *salesforceReact-apk-path
        - run-tests:
            requires:
              - "React API 27"
            name: "React API 26"
            lib: "SalesforceReact"
            test_apk: *salesforceReact-apk-path
        - run-tests:
            requires:
              - "React API 26"
            name: "React API 25"
            lib: "SalesforceReact"
            test_apk: *salesforceReact-apk-path
        - run-tests:
            requires:
              - "React API 25"
            name: "React API 24"
            lib: "SalesforceReact"
            test_apk: *salesforceReact-apk-path
        - run-tests:
            requires:
              - "React API 24"
            name: "React API 23"
            lib: "SalesforceReact"
            test_apk: *salesforceReact-apk-path
        - run-tests:
            requires:
              - "React API 23"
            name: "React API 22"
            lib: "SalesforceReact"
            test_apk: *salesforceReact-apk-path
        - run-tests:
            requires:
              - "React API 22"
            name: "React API 21"
            lib: "SalesforceReact"
            test_apk: *salesforceReact-apk-path